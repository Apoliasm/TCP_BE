datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        Int       @id @default(autoincrement())
  nickname  String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  listings  Listing[]
}

model Listing {
  id        Int       @id @default(autoincrement())
  title     String
  items     ListingItem[]
  images    ListingImage[]
  status    ListingStatus @default(ON_SALE)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  sellerId  Int
  seller    User      @relation(fields: [sellerId], references: [id])
}

enum ListingStatus {
  ON_SALE
  RESERVED
  SOLD
  DRAFT
}

model ListingImage {
  id        Int       @id @default(autoincrement())
  listingId Int?
  listing   Listing?   @relation(fields: [listingId], references: [id])

  imageUrl  String
  order     Int?      // 정렬용

  items     ListingItem[]
}


enum ListingItemType {
  CARD
  ACCESSORY
  OTHER
}

model ItemInfo{
  id Int @id @default(autoincrement())
  type ListingItemType
  listingItems  ListingItem[]

  cardInfo CardInfo?
  accessoryInfo AccessoryInfo?
}

model ListingItem {
  id           Int             @id @default(autoincrement())
  listingId    Int
  listing      Listing         @relation(fields: [listingId], references: [id])

  // 이 아이템이 어떤 사진 아래에 표시될지 (없으면 null)
  listingImageId Int?
  listingImage   ListingImage? @relation(fields: [listingImageId], references: [id])

  infoId   Int?
  itemInfo     ItemInfo?  @relation(fields:[infoId] ,references:[id])
  detail       String?
  condition    String?
  quantity     Int
  pricePerUnit Int

  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
}



model AccessoryInfo{
  itemInfoId  Int    @id
  itemInfo    ItemInfo @relation(fields: [itemInfoId], references: [id])
  name String

  @@unique(name)
}

enum CardNation{
  KR
  JP
  EN
  Other
}

enum Rarity{
  N
  R
  SR
  UR
  UL
  SE
  QCSE
  Prismatic
  UPR
  NPR
  Other
}

model CardName{
  id   Int     @id @default(autoincrement())
  name String   @unique
  cardInfos CardInfo[]
  passcode String? 
}

model CardCandidates {
  id Int @id @default(autoincrement())
  name String @unique
  CardInfos CardInfo[]
}

model CardInfo{
  itemInfoId Int @id
  itemInfo   ItemInfo @relation(fields: [itemInfoId], references: [id])
  
  cardNameId Int?
  cardName CardName? @relation(fields : [cardNameId], references : [id])
  candidateId Int?
  candidate CardCandidates? @relation(fields: [candidateId], references: [id])
  cardCode String? 
  nation CardNation
  rarity Rarity 
  // 둘 중 어느 쪽을 쓰든 rarity와 함께 유일해야 함
  @@unique([cardNameId, rarity])
  @@unique([candidateId, rarity])

}

model SyncMeta {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}
